rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 輔助函數：取得用戶資料
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // 輔助函數：檢查是否為 owner
    function isOwner() {
      return request.auth != null && getUserData().role == 'owner';
    }
    
    // 輔助函數：檢查是否有權管理特定班級
    function canManageClass(classId) {
      let userData = getUserData();
      return request.auth != null && 
        (userData.role == 'owner' || 
         (userData.role == 'classAdmin' && userData.classId == classId));
    }
    
    // 用戶資料
    match /users/{userId} {
      // 讀取自己的資料
      allow read: if request.auth != null && request.auth.uid == userId;
      // 寫入自己的資料（但不能改 role）
      allow write: if request.auth != null && request.auth.uid == userId;
      // owner 可以讀取所有用戶（用於審核列表）
      allow read: if isOwner();
      // owner 可以更新任何用戶的 role（用於審核）
      allow update: if isOwner();
    }
    
    // 班級廚房主文件
    match /kitchens/{classId} {
      // owner 可以讀寫所有班級
      allow read, write: if isOwner();
      // 班級管理員可以讀取自己的班級
      allow read: if canManageClass(classId);
    }
    
    // 班級廚房子集合 - 菜單
    match /kitchens/{classId}/menuItems/{itemId} {
      // 公開讀取（讓顧客可以看菜單）
      allow read: if true;
      // 公開更新（扣庫存用）
      allow update: if true;
      // 班級管理員或 owner 可以建立/刪除
      allow create, delete: if canManageClass(classId);
    }
    
    // 班級廚房子集合 - 訂單
    match /kitchens/{classId}/orders/{orderId} {
      // 公開建立（讓顧客可以下單）
      allow create: if true;
      // 公開讀取（讓顧客可以查看狀態）
      allow read: if true;
      // 班級管理員或 owner 可以更新/刪除
      allow update, delete: if canManageClass(classId);
    }
    
    // 班級廚房子集合 - 每日銷售統計
    match /kitchens/{classId}/dailySales/{date} {
      // 公開讀寫（下單時需要更新）
      allow read, write: if true;
    }
    
    // 班級廚房子集合 - 訂單計數器
    match /kitchens/{classId}/orderCounts/{date} {
      // 公開讀寫（用於生成訂單號）
      allow read, write: if true;
    }
    
    // 班級廚房子集合 - 系統設定
    match /kitchens/{classId}/system/{docId} {
      // 公開讀取（讓顧客知道是否營業中）
      allow read: if true;
      // 班級管理員或 owner 可以修改
      allow write: if canManageClass(classId);
    }
    
    // ====== 向後相容：舊的根級別集合 ======
    // 菜單：公開讀取和更新庫存
    match /menuItems/{itemId} {
      allow read: if true;
      allow update: if true;
      allow create, delete: if request.auth != null;
    }
    
    // 訂單：公開建立和讀取
    match /orders/{orderId} {
      allow create: if true;
      allow read: if true;
      allow update, delete: if request.auth != null;
    }
    
    // 系統設定：公開讀取
    match /system/{docId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // 每日銷售統計：公開讀寫
    match /dailySales/{date} {
      allow read, write: if true;
    }
    
    // 訂單計數器：公開讀寫
    match /orderCounts/{date} {
      allow read, write: if true;
    }
  }
}
